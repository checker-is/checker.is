

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>CFMM subsystem &mdash; Checker 0.1alpha documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Deploying Checker" href="deploying.html" />
    <link rel="prev" title="Liquidation Auctions" href="liquidation-auction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Checker
          

          
          </a>

          
            
            
              <div class="version">
                0.1alpha
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="functional_spec.html">Functional Specification</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="operational.html">Operational descriptions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="system-parameters.html">System Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="burrow-state-liquidations.html">Burrow State &amp; Liquidation</a></li>
<li class="toctree-l2"><a class="reference internal" href="liquidation-auction.html">Liquidation Auctions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CFMM subsystem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#state">State</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#general-notes-on-the-interfaces">General notes on the interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-liquidity">Adding liquidity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#inputs">Inputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#removing-liquidity">Removing liquidity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Inputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#buying-kit">Buying Kit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Inputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#selling-kit">Selling Kit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Inputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#misc">Misc</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deploying.html">Deploying Checker</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Checker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="operational.html">Operational descriptions</a> &raquo;</li>
        
      <li>CFMM subsystem</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/cfmm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cfmm-subsystem">
<h1>CFMM subsystem<a class="headerlink" href="#cfmm-subsystem" title="Permalink to this headline">¶</a></h1>
<p><strong>NOTE</strong>: CFMM stands for <em>Constant Function Market Maker</em>. What this
means is that when parties exchange kit for ctez and vice versa, using
checker, checker tries to keep the product of kit and ctez within it
unchanged (ignoring the fees of course).</p>
<p>This file gives an operational interpretation of the cfmm API inside the
checker contract, and operations on it.</p>
<div class="section" id="state">
<h2>State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ctez</span></code>: the total amount of ctez currently held by the cfmm contract (in muctez).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kit</span></code>: the total amount of kit currently held by the cfmm contract (in mukit).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lqt</span></code>: the total amount of liquidity held by the cfmm contract (in mulqt).</p></li>
</ul>
<p>Additional fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code>: the price of kit in ctez (<code class="docutils literal notranslate"><span class="pre">kit</span> <span class="pre">/</span> <span class="pre">ctez</span></code>)
at the end of the previous block (as a ratio).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">last_level</span></code>: the last block that the cfmm contract was touched on (as
a nat).</p></li>
</ul>
<p><strong>NOTE 1</strong>: The reason we store <code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> and
<code class="docutils literal notranslate"><span class="pre">last_level</span></code> in the state of cfmm is security. When the price implied
by cfmm is queried to compute the drift derivative (see
system-parameters.md), we don’t want to give the current price, but
instead return the last price at the end of the previous block. This
makes it just a little harder to manipulate these small price
fluctuations.</p>
<p><strong>NOTE 2</strong>: <code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> is always computed as the
amount of kit divided by the amount of ctez, so it can never really grow
too much in size. Hence we use a lossless rational for its
representation.</p>
</div>
<div class="section" id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>When the system starts, all parameters are set to one. Given that
Checker gets deployed on the chain at level <code class="docutils literal notranslate"><span class="pre">lvl</span></code>, we initialize the
parameters thus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctez</span>                      <span class="o">=</span> <span class="mi">1</span><span class="n">muctez</span>
<span class="n">kit</span>                       <span class="o">=</span> <span class="mi">1</span><span class="n">mukit</span>
<span class="n">lqt</span>                       <span class="o">=</span> <span class="mi">1</span><span class="n">mulqt</span>
<span class="n">kit_in_ctez_in_prev_block</span> <span class="o">=</span> <span class="mi">1</span>     <span class="c1"># same as kit/ctez now</span>
<span class="n">last_level</span>                <span class="o">=</span> <span class="n">lvl</span>
</pre></div>
</div>
<p>Effectively, given that (a) no one can remove the first liquidity token
and (b) how rounding works in the operations that follow, the contract
will never be completely out of ctez, kit, or liquidity. So,
setting the initial values to one removes the need for division-by-zero
checks, and the first/non-first liquidity provider distinction that is
e.g. adopted by Dexter. Of course, this price is only for the beginning,
and it is expected that through trading it will eventually move closer
to the <em>real</em> price.</p>
</div>
<div class="section" id="general-notes-on-the-interfaces">
<h2>General notes on the interfaces<a class="headerlink" href="#general-notes-on-the-interfaces" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>None of the interfaces below refers to prices. Instead, we pass
inputs, and minimum and maximum expected values for things (e.g. kit,
ctez, liquidity, or time). If the criteria cannot be met the
operations fail. This agrees with e.g. the API offered by Dexter.</p></li>
<li><p>All the following happen within the smart contract, which means that
in the calculations below we often refer to <code class="docutils literal notranslate"><span class="pre">level</span></code> (the current
block height), as well as <code class="docutils literal notranslate"><span class="pre">now</span></code> (the timestamp of the current
block, as provided by this block’s baker).</p></li>
</ul>
</div>
<div class="section" id="adding-liquidity">
<h2>Adding liquidity<a class="headerlink" href="#adding-liquidity" title="Permalink to this headline">¶</a></h2>
<p>First things first: if <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">&lt;</span> <span class="pre">level</span></code>, it means that this is the
first time that the cfmm contract is touched in this block, so we update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> to the price observed now, and set
<code class="docutils literal notranslate"><span class="pre">last_level</span></code> to the current height, so that we don’t update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> again in this block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_in_ctez_in_prev_block</span> <span class="o">=</span> <span class="n">ctez</span><span class="o">/</span><span class="n">kit</span>
<span class="n">last_level</span>                <span class="o">=</span> <span class="n">level</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">=</span> <span class="pre">level</span></code>, then we don’t perform the update; this is not
the first time we’ve touched the cfmm contract in this block.</p>
<div class="section" id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ctez_amount</span></code>: The amount of ctez to be added to the cfmm contract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_kit_deposited</span></code>: The maximum amount of kit to be added to the cfmm
contract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_lqt_minted</span></code>: The minimum amount of liquidity expected to be
received.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deadline</span></code>: The deadline; starting from this timestamp the transaction can
no longer be executed.</p></li>
</ul>
<p>If any of the following holds, the transaction fails:</p>
<ul class="simple">
<li><p>If we are on or past the deadline (<code class="docutils literal notranslate"><span class="pre">now</span> <span class="pre">&gt;=</span> <span class="pre">deadline</span></code>), the transaction
fails.</p></li>
<li><p>If no ctez is given (<code class="docutils literal notranslate"><span class="pre">ctez_amount</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If no kit is offered (<code class="docutils literal notranslate"><span class="pre">max_kit_deposited</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If no liquidity is to be added (<code class="docutils literal notranslate"><span class="pre">min_lqt_minted</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction
fails.</p></li>
</ul>
<p>So, we calculate the amount of liquidity to mint and the amount of kit that
needs to be deposited using the ratio of the provided ctez vs. the ctez
currently in the cfmm contract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lqt_minted</span>    <span class="o">=</span> <span class="n">lqt</span> <span class="o">*</span> <span class="p">(</span><span class="n">ctez_amount</span> <span class="o">/</span> <span class="n">ctez</span><span class="p">)</span>    <span class="c1"># floor</span>
<span class="n">kit_deposited</span> <span class="o">=</span> <span class="n">kit</span> <span class="o">*</span> <span class="p">(</span><span class="n">ctez_amount</span> <span class="o">/</span> <span class="n">ctez</span><span class="p">)</span>    <span class="c1"># ceil</span>
</pre></div>
</div>
<p>Because of this calculation, we need to know that the pool of ctez is
not empty, but this should be ensured by the initial setup of the cfmm
sub-contract. Also</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">lqt_minted</span> <span class="pre">&lt;</span> <span class="pre">min_lqt_minted</span></code> then the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">max_kit_deposited</span> <span class="pre">&lt;</span> <span class="pre">kit_deposited</span></code> then the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">kit_deposited</span> <span class="pre">=</span> <span class="pre">Kit.zero</span></code> then the transaction fails.</p></li>
</ul>
<p>If all is good, we proceed with updating the parameters</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit</span>  <span class="o">=</span> <span class="n">kit</span> <span class="o">+</span> <span class="n">kit_deposited</span>
<span class="n">ctez</span> <span class="o">=</span> <span class="n">ctez</span> <span class="o">+</span> <span class="n">ctez_amount</span>
<span class="n">lqt</span>  <span class="o">=</span> <span class="n">lqt</span> <span class="o">+</span> <span class="n">lqt_minted</span>
</pre></div>
</div>
<p>Note that the complete <code class="docutils literal notranslate"><span class="pre">ctez_amount</span></code> is consumed. However,
<code class="docutils literal notranslate"><span class="pre">kit_deposited</span></code> might differ from <code class="docutils literal notranslate"><span class="pre">max_kit_deposited</span></code>. Hence, we
return the leftovers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_to_return</span>  <span class="o">=</span> <span class="n">max_kit_deposited</span> <span class="o">-</span> <span class="n">kit_deposited</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="removing-liquidity">
<h2>Removing liquidity<a class="headerlink" href="#removing-liquidity" title="Permalink to this headline">¶</a></h2>
<p>First things first: if <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">&lt;</span> <span class="pre">level</span></code>, it means that this is the
first time that the cfmm contract is touched in this block, so we update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> to the price observed now, and set
<code class="docutils literal notranslate"><span class="pre">last_level</span></code> to the current height, so that we don’t update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> again in this block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_in_ctez_in_prev_block</span> <span class="o">=</span> <span class="n">ctez</span><span class="o">/</span><span class="n">kit</span>
<span class="n">last_level</span>                <span class="o">=</span> <span class="n">level</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">=</span> <span class="pre">level</span></code>, then we don’t perform the update; this is not
the first time we’ve touched the cfmm contract in this block.</p>
<div class="section" id="id1">
<h3>Inputs<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lqt_burned</span></code>: The amount of liquidity to be removed from the cfmm contract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_ctez_withdrawn</span></code>: The minimum amount of ctez to be received for the removed liquidity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_kit_withdrawn</span></code>: The minimum amount of kit to be received for the removed liquidity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deadline</span></code>: The deadline; starting from this timestamp the transaction can no longer be executed.</p></li>
</ul>
<p>If any of the following holds, the transaction fails</p>
<ul class="simple">
<li><p>If we are on or past the deadline (<code class="docutils literal notranslate"><span class="pre">now</span> <span class="pre">&gt;=</span> <span class="pre">deadline</span></code>), the transaction fails.</p></li>
<li><p>If no liquidity is to be removed (<code class="docutils literal notranslate"><span class="pre">lqt_burned</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If no ctez is expected to be received from this transaction (<code class="docutils literal notranslate"><span class="pre">min_ctez_withdrawn</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If no kit is expected to be received from this transaction (<code class="docutils literal notranslate"><span class="pre">min_kit_withdrawn</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
</ul>
<p>Otherwise, we compute how much ctez and kit should be returned, using the ratio
of the provided liquidity vs. the liquidity currently in the cfmm contract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctez_withdrawn</span> <span class="o">=</span> <span class="n">ctez</span> <span class="o">*</span> <span class="p">(</span><span class="n">lqt_burned</span> <span class="o">/</span> <span class="n">lqt</span><span class="p">)</span>   <span class="c1"># floor</span>
<span class="n">kit_withdrawn</span>  <span class="o">=</span> <span class="n">kit</span>  <span class="o">*</span> <span class="p">(</span><span class="n">lqt_burned</span> <span class="o">/</span> <span class="n">lqt</span><span class="p">)</span>   <span class="c1"># floor</span>
</pre></div>
</div>
<p>Also, we check that the bounds are respected:</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">ctez_withdrawn</span> <span class="pre">&lt;</span> <span class="pre">min_ctez_withdrawn</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">ctez_withdrawn</span> <span class="pre">&gt;</span> <span class="pre">ctez</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">kit_withdrawn</span> <span class="pre">&lt;</span> <span class="pre">min_kit_withdrawn</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">kit_withdrawn</span> <span class="pre">&gt;</span> <span class="pre">kit</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">lqt_burned</span> <span class="pre">&gt;</span> <span class="pre">lqt</span></code>, the transaction fails.</p></li>
</ul>
<p>If all is good, we proceed with updating the parameters</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit</span>  <span class="o">=</span> <span class="n">kit</span>  <span class="o">-</span> <span class="n">kit_withdrawn</span>
<span class="n">ctez</span> <span class="o">=</span> <span class="n">ctez</span> <span class="o">-</span> <span class="n">ctez_withdrawn</span>
<span class="n">lqt</span>  <span class="o">=</span> <span class="n">lqt</span>  <span class="o">-</span> <span class="n">lqt_burned</span>
</pre></div>
</div>
<p>and return the withdrawn amounts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctez_to_return</span> <span class="o">=</span> <span class="n">ctez_withdrawn</span>
<span class="n">kit_to_return</span>  <span class="o">=</span> <span class="n">kit_withdrawn</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="buying-kit">
<h2>Buying Kit<a class="headerlink" href="#buying-kit" title="Permalink to this headline">¶</a></h2>
<p>First things first: if <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">&lt;</span> <span class="pre">level</span></code>, it means that this is the
first time that the cfmm contract is touched in this block, so we update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> to the price observed now, and set
<code class="docutils literal notranslate"><span class="pre">last_level</span></code> to the current height, so that we don’t update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> again in this block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_in_ctez_in_prev_block</span> <span class="o">=</span> <span class="n">ctez</span><span class="o">/</span><span class="n">kit</span>
<span class="n">last_level</span>                <span class="o">=</span> <span class="n">level</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">=</span> <span class="pre">level</span></code>, then we don’t perform the update; this is not
the first time we’ve touched the cfmm contract in this block.</p>
<div class="section" id="id2">
<h3>Inputs<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ctez_amount</span></code>: The amount of ctez to be added to the cfmm contract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_kit_expected</span></code>: The minimum amount of kit to be bought.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deadline</span></code>: The deadline; starting from this timestamp the transaction can no longer be executed.</p></li>
</ul>
<p>If any of the following holds, the transaction fails</p>
<ul class="simple">
<li><p>If the amount of ctez given is zero (<code class="docutils literal notranslate"><span class="pre">ctez_amount</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If we are on or past the deadline (<code class="docutils literal notranslate"><span class="pre">now</span> <span class="pre">&gt;=</span> <span class="pre">deadline</span></code>), the transaction fails.</p></li>
<li><p>If no amount of kit is expected (<code class="docutils literal notranslate"><span class="pre">min_kit_expected</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
</ul>
<p>Otherwise, we compute how much kit can be bought for the <code class="docutils literal notranslate"><span class="pre">ctez_amount</span></code>
of ctez as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">price</span>      <span class="o">=</span> <span class="n">kit</span> <span class="o">/</span> <span class="n">ctez</span>
<span class="n">slippage</span>   <span class="o">=</span> <span class="n">ctez</span> <span class="o">/</span> <span class="p">(</span><span class="n">ctez</span> <span class="o">+</span> <span class="n">ctez_amount</span><span class="p">)</span>
<span class="n">kit_bought</span> <span class="o">=</span> <span class="n">ctez_amount</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="n">slippage</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cfmm_fee</span><span class="p">)</span>   <span class="c1"># floor</span>
</pre></div>
</div>
<p>Also, we check that the bounds are respected:</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">kit_bought</span> <span class="pre">&lt;</span> <span class="pre">min_kit_expected</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">kit_bought</span> <span class="pre">&gt;</span> <span class="pre">kit</span></code>, the transaction fails.</p></li>
</ul>
<p>If all is good, we proceed with updating the parameters</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit</span>  <span class="o">=</span> <span class="n">kit</span>  <span class="o">-</span> <span class="n">kit_bought</span>
<span class="n">ctez</span> <span class="o">=</span> <span class="n">ctez</span> <span class="o">+</span> <span class="n">ctez_amount</span>
</pre></div>
</div>
<p>and return the bought amount of kit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_to_return</span> <span class="o">=</span> <span class="n">kit_bought</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="selling-kit">
<h2>Selling Kit<a class="headerlink" href="#selling-kit" title="Permalink to this headline">¶</a></h2>
<p>First things first: if <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">&lt;</span> <span class="pre">level</span></code>, it means that this is the
first time that the cfmm contract is touched in this block, so we update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> to the price observed now, and set
<code class="docutils literal notranslate"><span class="pre">last_level</span></code> to the current height, so that we don’t update
<code class="docutils literal notranslate"><span class="pre">kit_in_ctez_in_prev_block</span></code> again in this block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit_in_ctez_in_prev_block</span> <span class="o">=</span> <span class="n">ctez</span><span class="o">/</span><span class="n">kit</span>
<span class="n">last_level</span>                <span class="o">=</span> <span class="n">level</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">last_level</span> <span class="pre">=</span> <span class="pre">level</span></code>, then we don’t perform the update; this is not
the first time we’ve touched the cfmm contract in this block.</p>
<div class="section" id="id3">
<h3>Inputs<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kit_given</span></code>: The amount of kit to be sold to the cfmm contract.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_ctez_expected</span></code>: The minimum amount of ctez to be bought.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deadline</span></code>: The deadline; starting from this timestamp the transaction can no longer be executed.</p></li>
</ul>
<p>If any of the following holds, the transaction fails</p>
<ul class="simple">
<li><p>If the amount of kit given is zero (<code class="docutils literal notranslate"><span class="pre">kit_given</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
<li><p>If we are on or past the deadline (<code class="docutils literal notranslate"><span class="pre">now</span> <span class="pre">&gt;=</span> <span class="pre">deadline</span></code>), the transaction fails.</p></li>
<li><p>If no amount of ctez is expected (<code class="docutils literal notranslate"><span class="pre">min_ctez_expected</span> <span class="pre">=</span> <span class="pre">0</span></code>), the transaction fails.</p></li>
</ul>
<p>Otherwise, we compute how much ctez can be bought for the <code class="docutils literal notranslate"><span class="pre">kit_given</span></code>
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">price</span>       <span class="o">=</span> <span class="n">ctez</span> <span class="o">/</span> <span class="n">kit</span>
<span class="n">slippage</span>    <span class="o">=</span> <span class="n">kit</span> <span class="o">/</span> <span class="p">(</span><span class="n">kit</span> <span class="o">+</span> <span class="n">kit_given</span><span class="p">)</span>
<span class="n">ctez_bought</span> <span class="o">=</span> <span class="n">kit</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="n">slippage</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cfmm_fee</span><span class="p">)</span>   <span class="c1"># floor</span>
</pre></div>
</div>
<p>Also, we check that the bounds are respected:</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">ctez_bought</span> <span class="pre">&lt;</span> <span class="pre">min_ctez_expected</span></code>, the transaction fails.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">ctez_bought</span> <span class="pre">&gt;</span> <span class="pre">ctez</span></code>, the transaction fails.</p></li>
</ul>
<p>If all is good, we proceed with updating the parameters</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kit</span>  <span class="o">=</span> <span class="n">kit</span>  <span class="o">+</span> <span class="n">kit_given</span>
<span class="n">ctez</span> <span class="o">=</span> <span class="n">ctez</span> <span class="o">-</span> <span class="n">ctez_bought</span>
</pre></div>
</div>
<p>and return the bought amount of ctez:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctez_to_return</span> <span class="o">=</span> <span class="n">ctez_bought</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: There are more than one ways to calculate things when buying
and selling kit. Given that <code class="docutils literal notranslate"><span class="pre">da</span></code> amount of one quantity is given, what
we do essentially computes first what should the return be for the
product of quantities kept by cfmm to stay the same:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">da</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">da</span><span class="p">))</span>
</pre></div>
</div>
<p>and then keeps <code class="docutils literal notranslate"><span class="pre">fee</span></code> of that, thus returning <code class="docutils literal notranslate"><span class="pre">db</span></code> calculated instead
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">da</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">da</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fee</span><span class="p">)</span>
</pre></div>
</div>
<p>Dexter takes an alternative approach, where the fee is (conceptually, at
least) on the amount given. That is, the returned amount is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">da</span><span class="s1">&#39; * (b / (a + da&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>where</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">da</span><span class="s1">&#39; = da * (1 - fee)</span>
</pre></div>
</div>
<p>The two calculations give slightly different results, but hopefully that
is not a problem.</p>
</div>
</div>
<div class="section" id="misc">
<h2>Misc<a class="headerlink" href="#misc" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cfmm_fee</span> <span class="pre">=</span> <span class="pre">0.002</span></code></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="deploying.html" class="btn btn-neutral float-right" title="Deploying Checker" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="liquidation-auction.html" class="btn btn-neutral float-left" title="Liquidation Auctions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Nomadic Labs / Tweag.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>